{% load i18n static admin_modify suit_tags core_tags admin_urls %}
{% load url from suit_compat %}

<div class="btn-group" data-toggle="buttons-radio">
    <button id='{{ widget.name }}-tf' type="button"
            class="btn btn-mini{% if widget.value == 'file' %} active{% endif %} js-switch-to-file"
            autocomplete="off">{% blocktrans %}File from disk{% endblocktrans %} {{ new }}
    </button>
    <button id='{{ widget.name }}-tu' type="button"
            class="btn btn-mini{% if widget.value == 'link' %} active{% endif %} js-switch-to-link"
            autocomplete="off">{% blocktrans %}URL address{% endblocktrans %}
    </button>
    <input type="{{ widget.type }}" name="{{ widget.name }}"{% if widget.value != None %}
           value="{{ widget.value|stringformat:'s' }}"{% endif %}{% include "django/forms/widgets/attrs.html" %}
           class="js-switcher"/>
</div>

<script>
    (function ($) {
        $(document).ready(function () {
            let file_field = null;
            let data_date_field = null;
            let url_field = null;
            let switcher = null;
            let root = null;
            let file_switch = null;
            let url_switch = null;

            $('body').on('form-ready', function (event, form) {
                root = form;
                switcher = form.find('.js-switcher');
                url_switch = form.find('.js-switch-to-link');
                file_switch = form.find('.js-switch-to-file');

                data_date_field = form.find("[type=text][id$=\"data_date\"]").closest('.field-data_date')

                url_switch.on('click', function (ev) {
                    inline_form = $(ev.target).closest('fieldset.module');
                    inline_form.find('.field-file').hide();
                    inline_form.find('.field-data_date').hide();
                    inline_form.find('.field-link').show();
                    switcher.val('link');
                });

                file_switch.on('click', function (ev) {
                    inline_form = $(ev.target).closest('fieldset.module');
                    inline_form.find('.field-link').hide();
                    inline_form.find('.field-file').show();
                    inline_form.find('.field-data_date').show();
                    switcher.val('file');
                });
                
                $('body').trigger('switcher-ready', [root, switcher]);
            });
            
            $('body').on('file-field-rendered', function (ev, field) {
                file_field = field;
                setup_switcher();
            });

            $('body').on('url-field-rendered', function (ev, field) {
                url_field = field;
                setup_switcher();
            });

            let setup_switcher = function () {
                if (root && switcher && file_field && url_field) {
                    current_value = switcher.val();
                    if (!current_value)
                        current_value = 'file';
                    sw = root.find('.js-switch-to-' + current_value);
                    sw.trigger('click');
                }
            };
        });
    }(django.jQuery));
</script>
